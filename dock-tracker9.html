<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>Dock Tracker â€” History Only</title>
  <style>
    body { font-family: Arial, sans-serif; margin: 20px; background: #f7f7f7; }
    .hidden { display: none; }

    .statusButton {
      padding: 10px 20px; margin: 5px; font-size: 16px;
      cursor: pointer; color: white; border: none; border-radius: 5px;
    }

    .navButton {
      padding: 10px 20px; margin: 5px; border: none; font-size: 16px;
      cursor: pointer; color: white; border-radius: 5px;
      background-color: black;
    }

    .floorButton {
      padding: 8px 15px; margin: 3px; border: none; font-size: 14px;
      cursor: pointer; color: white; border-radius: 5px;
    }

    .floorButton.active { border: 2px solid black; }

    input, select {
      width: 100%; padding: 8px; margin-top: 10px;
      font-size: 16px; border-radius: 5px; border: 1px solid #ccc;
    }

    table { border-collapse: collapse; width: 100%; margin-top: 10px; background: white; }
    th, td { border: 1px solid black; padding: 5px; text-align: center; }

    h1, h2 { color: #333; }
  </style>
</head>
<body>

<h1>Dock Tracker</h1>

<div id="dockScreen">
  <h2 id="dockTitle"></h2>
  <div id="timestamp"></div>

  <button class="statusButton" style="background-color:green;" onclick="setStatus(false)">Available</button>
  <button class="statusButton" style="background-color:red;" onclick="setStatus(true)">Occupied</button>

  <input id="sealInput" placeholder="Enter Seal#..." oninput="saveSeal()">
  <input id="notesInput" placeholder="Enter notes..." oninput="saveNotes()">

  <div style="margin-top:10px;">
    <button class="navButton" onclick="prevDock()">Previous</button>
    <button class="navButton" onclick="nextDock()">Next</button>
    <button class="navButton" onclick="showSummary()">Daily Summary</button>
    <button class="navButton" onclick="resetData()">Reset Day</button>
    <button class="navButton" onclick="saveDailySnapshot()">Save Daily Snapshot</button>
    <button class="navButton" onclick="showHistory()">History Summary</button>
    <button class="navButton" onclick="exportHistory()">Export History</button>
  </div>

  <div id="jumpSection" style="margin-top:10px;">
    <label>Jump to Dock:</label>
    <select id="jumpDockSelect" onchange="jumpToDockFromDropdown()"></select>
  </div>

  <div id="floorButtons"></div>
</div>

<div id="summaryScreen" class="hidden"></div>

<script>
/* ---------- Helper to format timestamp ---------- */
function formatTimestamp(date) {
    const mm = String(date.getMonth() + 1).padStart(2, '0');
    const dd = String(date.getDate()).padStart(2, '0');
    const yy = String(date.getFullYear()).slice(-2);
    const hh = String(date.getHours()).padStart(2, '0');
    const min = String(date.getMinutes()).padStart(2, '0');
    const ss = String(date.getSeconds()).padStart(2, '0');
    return `${mm}-${dd}-${yy} ${hh}:${min}:${ss}`;
}

/* ---------- Data ---------- */
const floors = [
  {name:"level1N", docks:Array.from({length:7},(_,i)=>({dockNumber:i+1,status:null,timestamp:null,notes:"",seal:""}))},
  {name:"level1S", docks:Array.from({length:26},(_,i)=>({dockNumber:i+8,status:null,notes:"",seal:""}))},
  {name:"level3N", docks:Array.from({length:20},(_,i)=>({dockNumber:i+1,status:null,notes:"",seal:""}))
    .concat(Array.from({length:23},(_,i)=>({dockNumber:i+34,status:null,notes:"",seal:""})))},
  {name:"level3S", docks:Array.from({length:24},(_,i)=>({dockNumber:i+57,status:null,notes:"",seal:""}))},
  {name:"level4", docks:Array.from({length:47},(_,i)=>({dockNumber:i+1,status:null,notes:"",seal:""}))},
  {name:"level5", docks:Array.from({length:47},(_,i)=>({dockNumber:i+1,status:null,notes:"",seal:""}))}
];

let currentFloor = 0;
let currentDock = 0;
let historyData = JSON.parse(localStorage.getItem("dockHistory")) || {};

const floorColors = ["#f9e79f","#aed6f1","#d7bde2","#a3e4d7","#f5cba7","#f5b7b1"];
const floorButtonColors = ["#ff7f50","#6495ed","#ba55d3","#20b2aa","#ffa500","#ff69b4"];

/* ---------- Persistence ---------- */
function saveFloors(){localStorage.setItem("dockData",JSON.stringify(floors));}
function loadFloors(){
  const d=localStorage.getItem("dockData");
  if(d){
    const p=JSON.parse(d);
    p.forEach((f,i)=>{
      f.docks.forEach((dock,j)=>{
        if(floors[i].docks[j])Object.assign(floors[i].docks[j],dock);
      });
    });
  }
}
loadFloors();

/* ---------- Screen Update ---------- */
function updateScreen(){
  document.getElementById("dockScreen").classList.remove("hidden");
  document.getElementById("summaryScreen").classList.add("hidden");

  const dock=floors[currentFloor].docks[currentDock];
  document.getElementById("dockTitle").textContent=`${floors[currentFloor].name} - Dock ${dock.dockNumber}`;
  const ts=document.getElementById("timestamp");
  if(dock.status===null){ts.textContent="No updates yet";ts.style.color="gray";}
  else{ts.textContent=`Last updated: ${dock.timestamp}`;ts.style.color=dock.status?"red":"green";}
  document.getElementById("notesInput").value=dock.notes;
  document.getElementById("sealInput").value=dock.seal;
  document.body.style.backgroundColor=floorColors[currentFloor%floorColors.length];
  renderFloorButtons();
  updateJumpDropdown();
}

function renderFloorButtons(){
  const div=document.getElementById("floorButtons");
  div.innerHTML="";
  floors.forEach((f,i)=>{
    const b=document.createElement("button");
    b.textContent=f.name;
    b.className="floorButton";
    b.style.backgroundColor=floorButtonColors[i%floorButtonColors.length];
    if(i===currentFloor)b.classList.add("active");
    b.onclick=()=>{currentFloor=i;currentDock=0;updateScreen();};
    div.appendChild(b);
  });
}

function updateJumpDropdown(){
  const sel=document.getElementById("jumpDockSelect");
  sel.innerHTML="";
  floors[currentFloor].docks.forEach((d,i)=>{
    const o=document.createElement("option");
    o.value=d.dockNumber;o.textContent=`Dock ${d.dockNumber}`;
    if(i===currentDock)o.selected=true;sel.appendChild(o);
  });
}

/* ---------- Actions ---------- */
function saveNotes(){floors[currentFloor].docks[currentDock].notes=notesInput.value;saveFloors();}
function saveSeal(){floors[currentFloor].docks[currentDock].seal=sealInput.value;saveFloors();}
function setStatus(s){
  const d = floors[currentFloor].docks[currentDock];
  d.status = s;
  d.timestamp = formatTimestamp(new Date());
  saveFloors();
  nextDock();
}
function nextDock(){if(currentDock<floors[currentFloor].docks.length-1)currentDock++;else if(currentFloor<floors.length-1){currentFloor++;currentDock=0;}updateScreen();}
function prevDock(){if(currentDock>0)currentDock--;else if(currentFloor>0){currentFloor--;currentDock=floors[currentFloor].docks.length-1;}updateScreen();}
function jumpToDockFromDropdown(){const n=parseInt(jumpDockSelect.value);const i=floors[currentFloor].docks.findIndex(d=>d.dockNumber===n);if(i!==-1){currentDock=i;updateScreen();}}

/* ---------- Summary ---------- */
function showSummary(){
  const div=document.getElementById("summaryScreen");
  div.classList.remove("hidden");
  document.getElementById("dockScreen").classList.add("hidden");

  let html=`<button class='navButton' onclick='updateScreen()'>Back</button>
            <h2>Daily Summary</h2>
            <button class='navButton' onclick='downloadDailySummary()'>Download Daily Summary</button>
            <table border="1">
            <tr><th>Floor</th><th>Dock</th><th>Status</th><th>Timestamp</th><th>Seal#</th><th>Notes</th></tr>`;

  floors.forEach((f,i)=>f.docks.forEach(d=>{
    let s,c;if(d.status===null){s="Not Set";c="gray";}else if(d.status){s="Occupied";c="red";}else{s="Available";c="green";}
    html+=`<tr style="background:${floorColors[i]}"><td>${f.name}</td><td>${d.dockNumber}</td><td style="color:${c}">${s}</td><td>${d.timestamp||""}</td><td>${d.seal||""}</td><td>${d.notes||""}</td></tr>`;
  }));
  html+=`</table><button class='navButton' onclick='updateScreen()'>Back</button>`;
  div.innerHTML=html;
}

/* ---------- Export Daily Summary ---------- */
function downloadDailySummary(){
  let html=`<table border="1"><tr><th>Floor</th><th>Dock</th><th>Status</th><th>Timestamp</th><th>Seal#</th><th>Notes</th></tr>`;
  floors.forEach((f,i)=>f.docks.forEach(d=>{
    let s = d.status === null ? "Not Set" : d.status ? "Occupied" : "Available";
    let ts = d.timestamp || "";
    html += `<tr><td>${f.name}</td><td>${d.dockNumber}</td><td>${s}</td><td>${ts}</td><td>${d.seal||""}</td><td>${d.notes||""}</td></tr>`;
  }));
  html += "</table>";

  const blob = new Blob([html], { type: "application/vnd.ms-excel" });
  const link = document.createElement("a");
  const now = formatTimestamp(new Date()).replace(/[: ]/g,'_');
  link.href = URL.createObjectURL(blob);
  link.download = `daily_summary_${now}.xls`;
  link.click();
}

/* ---------- Reset & Save ---------- */
function resetData(){if(confirm("Reset all docks?")){floors.forEach(f=>f.docks.forEach(d=>Object.assign(d,{status:null,timestamp:null,notes:'',seal:''})));saveFloors();updateScreen();}}
function saveDailySnapshot(){const today=new Date().toISOString().split("T")[0];historyData[today]=JSON.parse(JSON.stringify(floors));localStorage.setItem("dockHistory",JSON.stringify(historyData));alert("Snapshot saved!");}

/* ---------- Auto Snapshot at Midnight ---------- */
function scheduleMidnightSnapshot(){
  const now=new Date();
  const msUntilMidnight=new Date(now.getFullYear(),now.getMonth(),now.getDate()+1,0,0,1)-now;
  setTimeout(()=>{saveDailySnapshot();scheduleMidnightSnapshot();},msUntilMidnight);
}
scheduleMidnightSnapshot();

/* ---------- History ---------- */
function showHistory(){
  const div=document.getElementById("summaryScreen");
  div.classList.remove("hidden");
  document.getElementById("dockScreen").classList.add("hidden");

  const keys=Object.keys(historyData).sort();
  if(!keys.length)return alert("No history yet.");

  let html=`<button class='navButton' onclick='updateScreen()'>Back</button>
            <h2>History Summary (All Days)</h2>`;

  keys.forEach(day=>{
    html+=`<h3>Date: ${day}</h3><table border="1">
           <tr><th>Floor</th><th>Dock</th><th>Status</th><th>Timestamp</th><th>Seal#</th><th>Notes</th></tr>`;

    historyData[day].forEach((f,i)=>f.docks.forEach(d=>{
      let s,c;if(d.status===null){s="Not Set";c="gray";}else if(d.status){s="Occupied";c="red";}else{s="Available";c="green";}
      html+=`<tr style="background:${floorColors[i]}"><td>${f.name}</td><td>${d.dockNumber}</td><td style="color:${c}">${s}</td><td>${d.timestamp||""}</td><td>${d.seal||""}</td><td>${d.notes||""}</td></tr>`;
    }));
    html+=`</table>`;
  });

  html+=`<button class='navButton' onclick='updateScreen()'>Back</button>`;
  div.innerHTML=html;
}

/* ---------- Export Full History ---------- */
function exportHistory(){
  const keys=Object.keys(historyData).sort();
  if(!keys.length)return alert("No history to export.");

  keys.forEach(day=>{
    const data=historyData[day];
    let html=`<table border="1"><tr><th>Floor</th><th>Dock</th><th>Status</th><th>Timestamp</th><th>Seal#</th><th>Notes</th></tr>`;
    data.forEach((f,i)=>f.docks.forEach(d=>{
      let s = d.status===null?"Not Set":d.status?"Occupied":"Available";
      html+=`<tr><td>${f.name}</td><td>${d.dockNumber}</td><td>${s}</td><td>${d.timestamp||""}</td><td>${d.seal||""}</td><td>${d.notes||""}</td></tr>`;
    }));
    html+="</table>";

    const blob = new Blob([html],{type:"application/vnd.ms-excel"});
    const link = document.createElement("a");
    link.href = URL.createObjectURL(blob);
    link.download = `history_${day.replace(/-/g,'_')}.xls`;
    link.click();
  });
}

/* ---------- Initialize ---------- */
updateScreen();
</script>

</body>
</html>
